---
title: "Removal models with finite mixtures"
output: pdf_document
---

## Intro

Solymos, P., Matsuoka, S. M., Bayne, E. M., Lele, S. R., Fontaine, P.,
Cumming, S. G., Stralberg, D., Schmiegelow, F. K. A. & Song, S. J., 2013.
Calibrating indices of avian density from non-standardized survey data:
making the most of a messy situation.
Methods in Ecology and Evolution 4:1047--1058.
<doi:10.1111/2041-210X.12106>

Solymos, P., Matsuoka, S. M., Cumming, S. G., Stralberg, D., Fontaine, P.,
Schmiegelow, F. K. A., Song, S. J., and Bayne, E. M., 2018.
Evaluating time-removal models for estimating availability of boreal birds
during point-count surveys: sample size requirements and model complexity.
Condor xx:xx--xx.

[Supporting info](https://github.com/psolymos/QPAD/tree/master/inst/doc/v2), including a tutorial for the QPAD method.


```{r}
#devtools::install_github("borealbirds/paired")
library(paired)
library(mefa4)
library(detect)
data(paired)
paired$SurveyType <- relevel(paired$SurveyType, "HUM")
aa <- table(paired$SPECIES)
SPP <- names(aa[aa >= 15])
SPP <- SPP[!(SPP %in% c("AMCR","AMGO","BCFR","BLJA","CANG","COLO","COGO","COME","CORA","EVGR","FRGU","GRAJ","UNKN","RESQ","WOSP","WWCR","WISN","SACR","PISI","UNBI","LEYE","GRYE","WOFR","UNKN"))]
paired<-paired[paired$SPECIES %in% SPP,]
xt <- Xtab(Count ~ PKEY + Interval + SPECIES, paired, 
               subset=paired$SurveyType == "HUM")[SPP]
```

Pick a species and define the correspondin data set

```{r}
spp <- "OVEN"
Y <- as.matrix(xt[[spp]][,c("0-3 min", "3-5 min", "5-10 min")])
X <- nonDuplicated(paired[paired$SurveyType == "HUM",], 
                   PKEY, TRUE)[rownames(Y),]
i <- !is.na(X$Latitude)
Y <- Y[i,]
X <- X[i,]
D <- matrix(c(3, 5, 10), nrow(Y), 3, byrow=TRUE)
```

Exponential

```{r}
Me0 <- cmulti(Y | D ~ 1, X, type="rem")
Me1 <- cmulti(Y | D ~ JDAY, X, type="rem")
Me2 <- cmulti(Y | D ~ TSSR, X, type="rem")

Me_AIC <- AIC(Me0, Me1, Me2)
Me_AIC$dAIC <- Me_AIC$AIC - min(Me_AIC$AIC)
```

Mixture model:

```{r}
Mf0 <- cmulti(Y | D ~ 1, X, type="fmix")
Mf1 <- cmulti(Y | D ~ JDAY, X, type="fmix")
Mf2 <- cmulti(Y | D ~ TSSR, X, type="fmix")

Mf_AIC <- AIC(Mf0, Mf1, Mf2)
Mf_AIC$dAIC <- Mf_AIC$AIC - min(Mf_AIC$AIC)
```

```{r}
Mm0 <- cmulti(Y | D ~ 1, X, type="mix")
Mm1 <- cmulti(Y | D ~ JDAY, X, type="mix")
Mm2 <- cmulti(Y | D ~ TSSR, X, type="mix")

Mm_AIC <- AIC(Mm0, Mm1, Mm2)
Mm_AIC$dAIC <- Mm_AIC$AIC - min(Mm_AIC$AIC)
```

```{r}
MeBest <- get(rownames(Me_AIC)[Me_AIC$dAIC == 0])
MfBest <- get(rownames(Mf_AIC)[Mf_AIC$dAIC == 0])
MmBest <- get(rownames(Mm_AIC)[Mm_AIC$dAIC == 0])
M_AIC <- AIC(MeBest, MfBest, MmBest)
M_AIC$dAIC <- M_AIC$AIC - min(M_AIC$AIC)

Me_AIC
summary(MeBest)

Mf_AIC
summary(MfBest)

Mm_AIC
summary(MmBest)

M_AIC
```

```{r}
n <- 100
JDAY <- seq(min(X$JDAY), max(X$JDAY), length.out=n)

be <- coef(MeBest)
pe <- 1-exp(-3*exp(be[1]+be[2]*JDAY))

bf <- coef(MfBest)
pf <- 1-plogis(bf[3])*exp(-3*exp(bf[1]+bf[2]*JDAY))

bm <- coef(MmBest)
pm <- 1-plogis(bm[2]+bm[3]*JDAY)*exp(-3*exp(bm[1]))

op <- par(las=1)
plot(JDAY, pe, ylim=c(0,1), type="l", main=spp,
    ylab="P(availability)")
lines(JDAY, pf, ylim=c(0,1), col=2)
lines(JDAY, pm, ylim=c(0,1), col=4)
legend("bottomright", bty="n", lty=1, col=c(1,2,4),
    legend=c("Me", "Mf", "Mm"))
par(op)
```

```{r}
Duration <- seq(0, 10, length.out=100)
op <- par(las=1)
plot(Duration, Duration, type="n", ylim=c(0,1),
    ylab="P(availability)")
for (i in seq_len(n)) {
    pe <- 1-exp(-Duration*exp(be[1]+be[2]*JDAY[i]))
    lines(Duration, pe, col=viridis::plasma(n, 0.2)[i])
}
for (i in seq_len(n)) {
    pm <- 1-plogis(bm[2]+bm[3]*JDAY[i])*exp(-Duration*exp(bm[1]))
    lines(Duration, pm, col=viridis::viridis(n, 0.2)[i])
}
for (i in seq_len(n)) {
    pf <- 1-plogis(bf[3])*exp(-Duration*exp(bf[1]+bf[2]*JDAY[i]))
    lines(Duration, pf, col=viridis::magma(n, 0.2)[i])
}
abline(v=3, col="grey")
par(op)
```

